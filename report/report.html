<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Adaptive Hydrology">
<meta name="dcterms.date" content="2024-07-06">

<title>Missoula Aquifer Sustainability Study</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="report_files/libs/clipboard/clipboard.min.js"></script>
<script src="report_files/libs/quarto-html/quarto.js"></script>
<script src="report_files/libs/quarto-html/popper.min.js"></script>
<script src="report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="report_files/libs/quarto-html/anchor.min.js"></script>
<link href="report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#study-area" id="toc-study-area" class="nav-link" data-scroll-target="#study-area">Study Area</a></li>
  <li><a href="#data-imputation-gap-filling" id="toc-data-imputation-gap-filling" class="nav-link" data-scroll-target="#data-imputation-gap-filling">Data Imputation (Gap Filling)</a></li>
  </ul></li>
  <li><a href="#historical-analysis" id="toc-historical-analysis" class="nav-link" data-scroll-target="#historical-analysis">Historical Analysis</a>
  <ul class="collapse">
  <li><a href="#clark-fork-river" id="toc-clark-fork-river" class="nav-link" data-scroll-target="#clark-fork-river">Clark Fork River</a></li>
  <li><a href="#groundwater-table-depth" id="toc-groundwater-table-depth" class="nav-link" data-scroll-target="#groundwater-table-depth">Groundwater Table Depth</a></li>
  <li><a href="#groundwater-withdrawals" id="toc-groundwater-withdrawals" class="nav-link" data-scroll-target="#groundwater-withdrawals">Groundwater Withdrawals</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Missoula Aquifer Sustainability Study</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Adaptive Hydrology </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 6, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The Missoula Aquifer is one of only 64 designated sole source aquifers in the United States.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> As such, it supplies over 75,000 residents, plus businesses, with potable groundwater. Historically, the aquifer has shown incredible resilience to drought and increases in population within the Missoula valley area. There have been no long-term signs of depletion in any of the 27 monitoring wells within the aquifer. This is likely due to the very high transmissivity rates, location within the Clark Fork and Bitterroot watersheds, reasonable historical growth rates of the surrounding population, and only mild changes in historical climate <span class="citation" data-cites="whitlock2017MontanaClimate2017">(<a href="#ref-whitlock2017MontanaClimate2017" role="doc-biblioref">Whitlock et al. 2017</a>)</span>.</p>
<p>Due to the unconfined nature of the aquifer and the high transmissivity rates of the substrate, the upstream inflows, and downstream outflows, of the aquifer are largely driven by the Clark Fork River <span class="citation" data-cites="tallmanSourcesWaterCaptured2005 millerNumericalFlowModel1991">(<a href="#ref-tallmanSourcesWaterCaptured2005" role="doc-biblioref">Tallman 2005</a>; <a href="#ref-millerNumericalFlowModel1991" role="doc-biblioref">Miller 1991</a>)</span>. In fact, according to previous studies, the Clark Fork River provides over 80% of the annual aquifer recharge (<a href="#tbl-miller" class="quarto-xref">Table&nbsp;1</a>). Thus, it is fair to say that any long-term changes in streamflow will likely have far reaching impacts to the recharge and overall sustainability of the aquifer.</p>
<div class="cell" data-execution_count="25">
<div id="tbl-miller" class="cell quarto-float anchored" data-execution_count="25">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-miller-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Missoula aquifer source of average annual inflow according to <span class="citation" data-cites="millerNumericalFlowModel1991">Miller (<a href="#ref-millerNumericalFlowModel1991" role="doc-biblioref">1991</a>)</span>.
</figcaption>
<div aria-describedby="tbl-miller-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="25">
<div>
<style type="text/css">
</style>

<table id="T_bf736" class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_bf736_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Source</th>
<th id="T_bf736_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Inflow (af/yr)</th>
<th id="T_bf736_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Percent of Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_bf736_row0_col0" class="data row0 col0">Clark Fork River</td>
<td id="T_bf736_row0_col1" class="data row0 col1">192000</td>
<td id="T_bf736_row0_col2" class="data row0 col2">82.76</td>
</tr>
<tr class="even">
<td id="T_bf736_row1_col0" class="data row1 col0">Creek Drainages and Tertiary Hillsides</td>
<td id="T_bf736_row1_col1" class="data row1 col1">19000</td>
<td id="T_bf736_row1_col2" class="data row1 col2">8.19</td>
</tr>
<tr class="odd">
<td id="T_bf736_row2_col0" class="data row2 col0">Lateral Underflow (Bitterroot and Hellgate)</td>
<td id="T_bf736_row2_col1" class="data row2 col1">21000</td>
<td id="T_bf736_row2_col2" class="data row2 col2">9.05</td>
</tr>
<tr class="even">
<td id="T_bf736_row3_col0" class="data row3 col0">Total</td>
<td id="T_bf736_row3_col1" class="data row3 col1">232000</td>
<td id="T_bf736_row3_col2" class="data row3 col2">100.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>Climate change is expected to impact the Clark Fork River in numerous ways over the coming decades <span class="citation" data-cites="whitlock2017MontanaClimate2017">(<a href="#ref-whitlock2017MontanaClimate2017" role="doc-biblioref">Whitlock et al. 2017</a>)</span>. Average annual discharge is projected to increase, although there is large uncertainty around this projection. With higher confidence, there is expected to be a shift in the timing of peak runoff leading towards lower base flows in the summer months. In addition, when future drought occurs, the severity is expected to increase, resulting in extended periods of drier than normal conditions <span class="citation" data-cites="montanadnrcMontanaDroughtManagement2023">(<a href="#ref-montanadnrcMontanaDroughtManagement2023" role="doc-biblioref">Montana DNRC 2023</a>)</span>. These projected changes will undoubtedly affect the groundwater of the Missoula Aquifer and impact local extractions for drinking water, irrigation, and industrial purposes.</p>
<p>From 2000 to 2024 the Missoula area population has increased from 57,000 to 78,000.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Using the standard assumption of 160 gallons/day/person, we estimate that water use has increased from 10,200 af to 14,100 af over this same time period (<a href="#fig-water-use" class="quarto-xref">Figure&nbsp;1</a>). Consequently, according to the Montana Ground Water Information Center<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> there are currently over 3,500 wells listed in the Missoula area. Of those wells, 247 are labeled as “public water,” which includes the City of Missoula’s water supply (<a href="#fig-extract-map" class="quarto-xref">Figure&nbsp;2</a>). Population in the Missoula area is expected to continue to increase over the next several decades<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> likely leading to more wells and higher extraction rates to sustain this growth. In spite of the historical resilience of the aquifer to these changes, many questions still remain unanswered.</p>
<div id="cell-fig-water-use" class="cell" data-execution_count="26">
<div class="cell-output cell-output-display">
<div id="fig-water-use" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-water-use-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-water-use-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-water-use-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Estimated water use based on the U.S. Census population data within the Missoula area and an average consumption of 160 gallons/day/person.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="fig-extract-map" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-extract-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/mso_map_of_all_wells.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-extract-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: All extraction wells within the Missoula area (eastern Missoula Aquifer).
</figcaption>
</figure>
</div>
<p>What if climate change and population growth converge to maximize stress on the aquifer? While these kinds of scenarios are not determined, they are all well within the realm of realistic possibilities, perhaps even probable. Given the overall resilience that we have seen in the past, it is possible that the aquifer can withstand these stressors and continue to deliver clean and plentiful potable water to the Missoula community in perpetuity. However, to date, no one has studied these different scenarios to make sure that our future water resources are protected. In this analysis, we first evaluate the long-term historial trends in Clark Fork River discharge, City of Missoula pumping rates, and Missoula Aquifer water table depth. In subsequent analyses (not inlcuded in this preliminary report) we plan to specifically study the impacts of plausible future scenarios on the Aquifer to identify critical tipping points and mitigation strategies.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<section id="study-area" class="level3">
<h3 class="anchored" data-anchor-id="study-area">Study Area</h3>
<p>The study area includes the greater Missoula area. Within this region there are 16 monitoring wells used in the analysis (<a href="#fig-site-map" class="quarto-xref">Figure&nbsp;3</a>).</p>
<div id="fig-site-map" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-site-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/site_map.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-site-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The study site including the 16 monitoring wells used in the analysis.
</figcaption>
</figure>
</div>
</section>
<section id="data-imputation-gap-filling" class="level3">
<h3 class="anchored" data-anchor-id="data-imputation-gap-filling">Data Imputation (Gap Filling)</h3>
<p>The historical groundwater measurements from the 16 monitoring wells used in our analyses, were taken sporadically and inconsistently over the study time period (<a href="#fig-gw-imputation" class="quarto-xref">Figure&nbsp;4</a>). Therefore, in order to compare across all sites we needed to fill the data gaps and resample to monthly average values. We used a two-step approach to gap fill the data. In the first step we identified the two wells with close to continuous data (e.g.&nbsp;151189 and 151190; <a href="#fig-gw-imputation" class="quarto-xref">Figure&nbsp;4</a>). We then used seasonal trend decomposition using LOESS (STL; <span class="citation" data-cites="clevelandSTLSeasonaltrendDecomposition1990">Cleveland et al. (<a href="#ref-clevelandSTLSeasonaltrendDecomposition1990" role="doc-biblioref">1990</a>)</span>) to fill in the few missing data points of those two wells. In the second step, we developed a multiple linear regression (MLR) model for each well using the two complete wells plus the day of year (i.e.&nbsp;last day of the month) as independent, predictor variables. We used this MLR model to impute data into the gaps of each well independently to create consistent monthly data across all water-years (2000-2023) in each monitoring well used in the study. We tested several other methods including linear interpolation, time-based interpolation, MLR using Clark Fork River flows, and STL by iterating the method 100 times and leaving out 5 known data points to later predict with the model. The multiple linear regression imputation method using the two complete wells and day of year proved to have the best error statistics across the all metrics (MAE, MSE, RMSE, MAPE, and R-squared; <a href="#tbl-error-stats" class="quarto-xref">Table&nbsp;2</a>)<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<div id="cell-fig-gw-imputation" class="cell" data-execution_count="27">
<div class="cell-output cell-output-display">
<div id="fig-gw-imputation" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gw-imputation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-gw-imputation-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gw-imputation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The groundwater monitoring sampling dates for each well before gap filling. The y-axis is the MT GWIC number of the well. The vertical lines represent the date sampled for each well. Color represents the value of the measurement (i.e.&nbsp;depth below ground). Since 2020, nearly all the wells have fairly dense records, missing few months (white areas). Only two wells (151189 &amp; 151190) have fairly full records (data for each month of the year). The others have sparse data in the beginning of the record. We used multiple linear regression imputation, to fill these gaps based on relationships between water table depth and the day of the year and the two wells with the most complete data. This resulted in a continuous monthly dataset from Oct 1999 through Sep 2023.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div id="tbl-error-stats" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-error-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Error statistics from the data imputation methods tested. For this study we used the STL Decomposition to fill data in the two most complete wells and then used the Well (MLR) Regression method using those two wells and day of year to build models for each well and use those models to gill gaps in the data record.
</figcaption>
<div aria-describedby="tbl-error-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MAE</th>
<th data-quarto-table-cell-role="th">MSE</th>
<th data-quarto-table-cell-role="th">RMSE</th>
<th data-quarto-table-cell-role="th">MAPE</th>
<th data-quarto-table-cell-role="th">R^2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Linear Interpolation</td>
<td>2.4923</td>
<td>13.8497</td>
<td>3.7215</td>
<td>10.5845</td>
<td>0.9556</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">STL Decomposition</td>
<td>1.3017</td>
<td>3.9748</td>
<td>1.9937</td>
<td>5.4697</td>
<td>0.9873</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Time Interpolation</td>
<td>2.4703</td>
<td>13.7026</td>
<td>3.7017</td>
<td>10.5757</td>
<td>0.9563</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Q and DOY Regression</td>
<td>1.6086</td>
<td>4.9560</td>
<td>2.2262</td>
<td>6.1077</td>
<td>0.9843</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Well Regression</td>
<td>0.9365</td>
<td>1.9474</td>
<td>1.3955</td>
<td>4.5326</td>
<td>0.9929</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</figure>
</div>
</div>
</section>
</section>
<section id="historical-analysis" class="level2">
<h2 class="anchored" data-anchor-id="historical-analysis">Historical Analysis</h2>
<section id="clark-fork-river" class="level3">
<h3 class="anchored" data-anchor-id="clark-fork-river">Clark Fork River</h3>
<p>The Clark Fork River serves as the main source for aquifer recharge in the Missoula Valley <span class="citation" data-cites="tallmanSourcesWaterCaptured2005">(<a href="#ref-tallmanSourcesWaterCaptured2005" role="doc-biblioref">Tallman 2005</a>)</span>. While other inputs exist, we focus almost exclusively on the Clark Fork due to the overall magnitude relative to other inputs. A seasonal decomposition using LOESS <span class="citation" data-cites="clevelandSTLSeasonaltrendDecomposition1990">(<a href="#ref-clevelandSTLSeasonaltrendDecomposition1990" role="doc-biblioref">Cleveland et al. 1990</a>)</span> shows that there has been a consistent increasing trend in monthly average flows over the study period (2000-2023; <a href="#fig-cfr-stl" class="quarto-xref">Figure&nbsp;5</a>). Change was steepest through 2011 and then flattened through the rest of the record. In addition, as expected, there is a strong seasonality component with peak flows coming in late spring and baseflows in late summer and early fall. The magnitude of seasonality is increasing, with the peaks getting higher and the troughs getting lower – suggesting an increasing trend in interannual variability through time.</p>
<div id="cell-fig-cfr-stl" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display">
<div id="fig-cfr-stl" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cfr-stl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-cfr-stl-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cfr-stl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Seasonal decomposition of the Clark Fork River monthly streamflows. The top panel (A) is the full stremflow signal–the mean daily discharge for each month from 2000 to 2023. The second panel (B) shows the trend over the time period with other signals removed. The third panel (C) is the seasonal signal without the trend. And the bottom panel (D) is the remainder of the signal no catpured by the trend and seasonal components.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We further investigate the trend of the Clark Fork River flows using a Mann-Kendall statistical significance test <span class="citation" data-cites="mannNonparametricTestsTrend1945 kendallRankCorrelationMethods1975">(<a href="#ref-mannNonparametricTestsTrend1945" role="doc-biblioref">Mann 1945</a>; <a href="#ref-kendallRankCorrelationMethods1975" role="doc-biblioref">Kendall 1975</a>)</span>, which avoids assumptions of normality and independence. The results indicate a statistically significant (<span class="math inline">\(p&lt;0.05\)</span>) increasing trend of 24 cfs/month. We further break down the trend analysis into seasons: winter (December, January, February), spring (March, April, May), summer (June, July, August), and fall (September, October, November) (<a href="#fig-cfr-seas-trends" class="quarto-xref">Figure&nbsp;6</a>). All four seasons have increasing trends, although the summer season’s trend is not statistically significant at the <span class="math inline">\(p&lt;0.05\)</span> level. The spring runoff trend is by far the strongest, representing a slope 113 cfs/season. Spring is the season where most of the recharge from the Clark Fork River to the Missoula Aquifer occurs <span class="citation" data-cites="tallmanSourcesWaterCaptured2005">(<a href="#ref-tallmanSourcesWaterCaptured2005" role="doc-biblioref">Tallman 2005</a>)</span>.</p>
<div id="cell-fig-cfr-seas-trends" class="cell" data-execution_count="8">
<div class="cell-output cell-output-display">
<div id="fig-cfr-seas-trends" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cfr-seas-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-cfr-seas-trends-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cfr-seas-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Seasonal trends for Clark Fork River flows. Red line indicate a statistically significant (<span class="math inline">\(p&lt;0.05\)</span>) trend; black line indicates a non- statistically significant ($&gt;=0.05) trend. The amount of the trend in cfs/season and p-values are shown on each panel.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="groundwater-table-depth" class="level3">
<h3 class="anchored" data-anchor-id="groundwater-table-depth">Groundwater Table Depth</h3>
<p>We evaluated trends in groundwater table depth for each of the 16 wells within the study site using the Mann-Kendall test. All 16 wells have statistically significant increasing trends and strong seasonality, similar to the Clark Fork River streamflow (<a href="#fig-gw-trends" class="quarto-xref">Figure&nbsp;7</a>). On average, there has been approximately a 1.9 foot increase in elevation of the water table over the period of record. Trends and timeseries data are very similar across all the sites, supporting previous studies showing high transmissivity throughout the aquifer <span class="citation" data-cites="tallmanSourcesWaterCaptured2005 millerNumericalFlowModel1991">(<a href="#ref-tallmanSourcesWaterCaptured2005" role="doc-biblioref">Tallman 2005</a>; <a href="#ref-millerNumericalFlowModel1991" role="doc-biblioref">Miller 1991</a>)</span>.</p>
<div id="cell-fig-gw-trends" class="cell" data-execution_count="9">
<div class="cell-output cell-output-display">
<div id="fig-gw-trends" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gw-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-gw-trends-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gw-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Trends in groundwater depth for the 16 wells within the study area. Red line indicates a statistically significant trend (<span class="math inline">\(p&lt;0.05\)</span>).
</figcaption>
</figure>
</div>
</div>
</div>
<p>Additionally, we calculated the 10th, 50th, and 90th quantile regression lines to show trends in lower, median, and upper groundwater values, respectively (<a href="#fig-gw-quantreg" class="quarto-xref">Figure&nbsp;8</a>). The changes in the 10th and 90th quantiles can be thought of as changes in the late Summer and early Spring since those are the times of year when groundwater elevations are at a minimum and maximum, respectively. The results show strong increasing trends in the 90th quantile, suggesting that increases in peak recharge events in the Spring are largely driving the overall trend in the groundwater. Median and lower quantiles show less of an increasing trend. The difference in trends between the 90th and 10th percentile also suggest an overall increase in interannual variability throughout the time period, similar to the seasonality trend in the Clark Fork River seasonal decomposition analysis (<a href="#fig-cfr-stl" class="quarto-xref">Figure&nbsp;5</a>).</p>
<div id="cell-fig-gw-quantreg" class="cell" data-execution_count="10">
<div class="cell-output cell-output-display">
<div id="fig-gw-quantreg" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gw-quantreg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-gw-quantreg-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gw-quantreg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Upper (90th percentile), median (50th percentile, dashed), and lower (10th percentile) trends in groundwater data. The 90th percentile trends are consistently the largest, suggesting increases in peak recharge events and interannual variability.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="groundwater-withdrawals" class="level3">
<h3 class="anchored" data-anchor-id="groundwater-withdrawals">Groundwater Withdrawals</h3>
<p>To understand the relationship and patterns of groundwater levels, Clark Fork streamflow, and Missoula City pumping rates, we normalize all monthly values to be between zero and one (<a href="#fig-norm-ts" class="quarto-xref">Figure&nbsp;9</a>). We average the normalized groundwater depths across all wells to get a representative groundwater signal to compare to river flows and pumping rates. The signals are remarkably aligned in their seasonality. Essentially, the City is increasing their pumping at the same time streamflow, and thus groundwater, are at their maximum. This is an opportunitistic situation and one that should be monitored closely if streamflow timing were to shift due to changes in snowpack runoff, as projected by climate change studies <span class="citation" data-cites="whitlock2017MontanaClimate2017">(<a href="#ref-whitlock2017MontanaClimate2017" role="doc-biblioref">Whitlock et al. 2017</a>)</span>. The main difference in these three signals is the lagged decrease in groundwater levels in comparison to the river and pumping rate. Groundwater tends to drop much slower than the two independent variables, suggesting there is some storage effect in the unconfined aquifer. This may help to mitigate some future shifts in peak streamflow if they were to occur.</p>
<div id="cell-fig-norm-ts" class="cell" data-execution_count="11">
<div class="cell-output cell-output-display">
<div id="fig-norm-ts" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-norm-ts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-norm-ts-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-norm-ts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Normalized timeseries values for average groundwater depth (blue), Clark Fork River streamflow (orange), and Missoula City pumping rates (green). All values are monthly averages.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We perform a seasonal decomposition analysis using LOESS on the City pumping rate time series <span class="citation" data-cites="clevelandSTLSeasonaltrendDecomposition1990">(<a href="#ref-clevelandSTLSeasonaltrendDecomposition1990" role="doc-biblioref">Cleveland et al. 1990</a>)</span>. Similar to the Clark Fork River flows and groundwater level, the City pumping rate has a slight increasing trend and strong seasonality over the study time period (<a href="#fig-pumping-stl" class="quarto-xref">Figure&nbsp;10</a>). While the overall trend is increasing, there are three smaller trends that are distinct across the time period. From 2000 to 2008 the pumping rate increases, then from 2009 to 2015 the pumping rate decreases, followed by another strong increasing trend from 2016 to 2023. The effects of these inflection points in the pumping rate trends are explored in further detail later in this section.</p>
<div id="cell-fig-pumping-stl" class="cell" data-execution_count="16">
<div class="cell-output cell-output-display">
<div id="fig-pumping-stl" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pumping-stl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-pumping-stl-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pumping-stl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: The seasonal decomposition using LOESS of the City of Missoula pumping rates. Panel A) is the combined signal, panel B) is the trend, panel C) is the seasonality, and panel D) is the residual after trend and seasonality are removed.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The most recent 10 water-years (2014-2023) provide an interesting case study. Over this time period, pumping rates have strongly increased (<a href="#fig-pumping-stl" class="quarto-xref">Figure&nbsp;10</a> B) and river flows have remained around the same (slight increase; <a href="#fig-cfr-stl" class="quarto-xref">Figure&nbsp;5</a> B), yet the groundwater trends from all of the wells have decreased over this time period. Furthermore, most of these decreases are statistically significant (<a href="#fig-gw-recent" class="quarto-xref">Figure&nbsp;11</a>). This suggests that there are likely other factors (i.e.&nbsp;groundwater witdrawals), beyond the Clark Fork River flows, influencing groundwater levels.</p>
<div id="cell-fig-gw-recent" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display">
<div id="fig-gw-recent" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gw-recent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-gw-recent-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gw-recent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: The most recent 10-years of groundwater level data with trends (significant and non-significant).
</figcaption>
</figure>
</div>
</div>
</div>
<p>In order to understand how withdrawals may be impacting groundwater levels over the entire time period, we remove the normalized trend in river flow from the groundwater signal at all wells (<a href="#fig-gw-qremoved" class="quarto-xref">Figure&nbsp;12</a>). This is, we produce a time series of what ground water depth would look like if the increasing trend of the Clark Fork River flow was removed. This allows us to focus on what the groundwater level would be doing if there was no trend in recharge from the river. With the river flow trend removed, increasing trends in groundwater elevation are reduced in all 16 wells. Five of the 16 lose statistical significance and one shifts from increasing to decreasing; although not statistically significant. This suggests that if the river flows were not increasing over this time period, groundwater trends would not have the same strong increasing trend that we see in the record. Thus, it appears that there is a potential for the river to mask the impact of City pumping rates and that without the increasing streamflow we may see much different behavior in the aquifer water table.</p>
<div id="cell-fig-gw-qremoved" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div id="fig-gw-qremoved" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gw-qremoved-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-gw-qremoved-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gw-qremoved-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Trends in groundwater depth after the normalized Clark Fork River has been removed.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In reality there is not a single long-term trend in pumping rates, but instead, three short-term trends (<a href="#fig-pumping-stl" class="quarto-xref">Figure&nbsp;10</a> B). The first trend is increasing from 2000 to 2008, the next trend is decreasing from 2009 to 2015, and the last trend is increasing from 2016 to 2023. With the effects from the Clark Fork River trends removed we explore the trends in the average normalized groundwater elevation and pumping rates over these three distinct time periods (<a href="#fig-gw-pr-trends" class="quarto-xref">Figure&nbsp;13</a>). In the first time period (2000-2008) groundwater elevation decreases as pumping rates increase. In the second time period (2009-2015) groundwater elevation increases as pumping rates decrease. And in the third time period (2016-2023) groundwater elevation decreases as pumping rates increase. All trends in both the groundwater and pumping rates are statistically significant. This analysis suggests that City pumping rates can impact the groundwater level in statistically signifacant ways. Therefore, without the recent increase in streamflow, we might be experiencing very different trends in the Missoula Aquifer level. If trends in Clark Fork River flows were to reverse (or even stabilize) and pumping rates were to continue to increase, it is possible that an unstainable condition in the groundwater level could be created.</p>
<div id="cell-fig-gw-pr-trends" class="cell" data-execution_count="20">
<div class="cell-output cell-output-display">
<div id="fig-gw-pr-trends" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gw-pr-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="report_files/figure-html/fig-gw-pr-trends-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gw-pr-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Trends in normalized average groundwater depth after CFR trend removed from the data (i.e.&nbsp;corrected; blue) and trends in normalized Missoula City pumping rates (red) over three different time periods: (1) 2000–2008, (2) 2009–2015, and (3) 2016–2023. These time periods were chosen to correspond with the inflection points of change illustrated in <a href="#fig-pumping-stl" class="quarto-xref">Figure&nbsp;10</a>. All trends are statistically significant at the <span class="math inline">\(p&lt;0.05\)</span> level.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>We define sustainable aquifer conditions as those in which groundwater depth is either not changing or increasing over time. Over the past 23 years the Missoula Aquifer has been incredibly resilient and even with varying pumping rates all groundwater wells show an overall increasing water table elevation. However, over the most recent 10-years of data, all groundwater levels are decreasing and most of them significantly. This is likely due to the smaller increasing trend in recharge from the river and increasing pumping rates from the City. Additionally, when the trend in the river is removed from the groundwater time series, overall trends in the water table depth are reduced and trends in shorter time periods follow, inversely, the trends in pumping rates. We believe that if population continues to grow and pumping rates increase to match demand, this could present an unsustainable aquifer condition if recharge rates stabilize, or worse decrease. Given these results, we believe that, while the groundwater table has been historically stable over the period of record, the City should not rest on these laurels and should continue to look for ways to mitigate the impacts of increasing population and climate change in the valley.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-clevelandSTLSeasonaltrendDecomposition1990" class="csl-entry" role="listitem">
Cleveland, Robert B., William S. Cleveland, Jean E. McRae, and Irma Terpenning. 1990. <span>“<span>STL</span>: <span>A</span> Seasonal-Trend Decomposition.”</span> <em>J. Off. Stat</em> 6 (1): 3–73.
</div>
<div id="ref-kendallRankCorrelationMethods1975" class="csl-entry" role="listitem">
Kendall, Maurice George. 1975. <span>“Rank Correlation Methods.”</span>
</div>
<div id="ref-mannNonparametricTestsTrend1945" class="csl-entry" role="listitem">
Mann, Henry B. 1945. <span>“Nonparametric Tests Against Trend.”</span> <em>Econometrica: Journal of the Econometric Society</em>, 245–59. <a href="https://www.jstor.org/stable/1907187">https://www.jstor.org/stable/1907187</a>.
</div>
<div id="ref-millerNumericalFlowModel1991" class="csl-entry" role="listitem">
Miller, Ross. 1991. <span>“Numerical Flow Model of the <span>Missoula Aquifer</span> : Interpretation of Aquifer Properties and River Interaction.”</span> <em>Graduate Student Theses, Dissertations, &amp; Professional Papers</em>, January.
</div>
<div id="ref-montanadnrcMontanaDroughtManagement2023" class="csl-entry" role="listitem">
Montana DNRC. 2023. <span>“Montana <span>Drought Management Plan</span>.”</span> Helena, MT.
</div>
<div id="ref-tallmanSourcesWaterCaptured2005" class="csl-entry" role="listitem">
Tallman, Amelia. 2005. <span>“Sources of Water Captured by Municipal Supply Wells in a Highly Conductive Aquifer Western <span>Montana</span>.”</span> <em>Graduate Student Theses, Dissertations, &amp; Professional Papers</em>, January.
</div>
<div id="ref-whitlock2017MontanaClimate2017" class="csl-entry" role="listitem">
Whitlock, Cathy, Wyatt F Cross, Bruce D Maxwell, Nick Silverman, and Alisa A Wade. 2017. <span>“2017 <span>Montana Climate Assessment</span>: <span>Stakeholder</span> Driven, Science Informed,”</span> September, 1–269. <a href="https://doi.org/10.15788/M2WW8W">https://doi.org/10.15788/M2WW8W</a>.
</div>
</div>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>https://www.epa.gov/dwssa<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>https://www.census.gov/programs-surveys/popest.html<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>https://mbmggwic.mtech.edu<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Correspondence with Marc Hendrickson on 2/13/2024<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>https://vitalflux.com/mse-vs-rmse-vs-mae-vs-mape-vs-r-squared-when-to-use<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>